// SPDX-License-Identifier: MIT
pragma solidity 0.8.24;

import {Test, console2 as console} from "forge-std/Test.sol";
import {Vm} from "forge-std/Vm.sol";

import {FalconVerify} from "../src/FalconVerify.sol";
import {DeployFalconVerify} from "../script/DeployFalconVerify.s.sol";
import {MockFalconData} from "./mocks/MockFalconData.sol";
import {FalconConstants} from "../src/FalconConstants.sol";
import {FalconHelperFunctions} from "../src/FalconHelperFunctions.sol";
import {FalconPkPacked} from "../src/FalconPkPacked.sol";
import {FalconPkPackedUtils} from "../src/FalconPkPacked.sol";
import {FalconSigCompressed} from "../src/FalconSigCompressed.sol";
import {FalconSigCompressedUtils} from "../src/FalconSigCompressed.sol";

contract SimpleFalconVerificationTest is Test, FalconConstants, FalconHelperFunctions {
    FalconVerify falconVerify;
    MockFalconData mockData;
    FalconPkPackedUtils falconPkPackedUtils;
    FalconSigCompressedUtils falconSigCompressedUtils;
    uint16 n;
    int16[1024] public mockIsShortDataSets;
    int16[1024] public mockIsShortDataSets2;

    function setUp() public {
        DeployFalconVerify deployer = new DeployFalconVerify();
        falconVerify = deployer.run();
        mockData = new MockFalconData();
        falconPkPackedUtils = new FalconPkPackedUtils();
        falconSigCompressedUtils = new FalconSigCompressedUtils();
        n = uint16(1) << uint16(FalconConstants.LOGN);
        mockIsShortDataSets = [
            -351,
            -17,
            -188,
            34,
            -155,
            -185,
            330,
            -188,
            -385,
            101,
            265,
            222,
            8,
            166,
            -64,
            -341,
            -248,
            1,
            -172,
            -46,
            76,
            -193,
            -31,
            43,
            -117,
            -244,
            35,
            64,
            213,
            -80,
            -76,
            -196,
            249,
            -10,
            74,
            76,
            -79,
            -95,
            20,
            -21,
            68,
            250,
            -109,
            136,
            -475,
            -165,
            99,
            238,
            42,
            -107,
            -79,
            -44,
            -128,
            113,
            12,
            193,
            -243,
            282,
            -232,
            189,
            -6,
            305,
            97,
            0,
            420,
            -140,
            63,
            -398,
            46,
            -151,
            57,
            28,
            150,
            -276,
            53,
            69,
            42,
            -159,
            163,
            188,
            44,
            116,
            88,
            61,
            302,
            313,
            237,
            -364,
            28,
            10,
            -64,
            -465,
            89,
            474,
            -356,
            -79,
            -98,
            23,
            241,
            259,
            -79,
            39,
            -130,
            258,
            -32,
            -318,
            147,
            26,
            5,
            129,
            38,
            12,
            324,
            364,
            -24,
            346,
            157,
            45,
            -24,
            97,
            -12,
            46,
            -84,
            320,
            188,
            -16,
            82,
            -11,
            165,
            -312,
            31,
            10,
            326,
            30,
            -68,
            34,
            -15,
            -21,
            16,
            81,
            -401,
            -298,
            256,
            137,
            -356,
            197,
            -91,
            -22,
            84,
            239,
            -24,
            253,
            129,
            -122,
            -125,
            -141,
            82,
            103,
            -383,
            151,
            194,
            -282,
            129,
            102,
            172,
            -56,
            87,
            -37,
            97,
            198,
            34,
            159,
            206,
            174,
            -11,
            -101,
            298,
            -146,
            -146,
            143,
            403,
            -75,
            -82,
            -29,
            -284,
            51,
            -88,
            130,
            144,
            1,
            2,
            85,
            -278,
            11,
            27,
            85,
            -151,
            -53,
            95,
            -98,
            267,
            301,
            226,
            48,
            216,
            -21,
            -261,
            27,
            -129,
            111,
            -15,
            -19,
            -375,
            113,
            -128,
            -368,
            28,
            94,
            257,
            -82,
            55,
            -34,
            -8,
            -113,
            -244,
            16,
            149,
            -209,
            -59,
            -138,
            161,
            272,
            -47,
            28,
            -155,
            -31,
            154,
            -77,
            216,
            -64,
            -353,
            -234,
            -89,
            74,
            63,
            -43,
            119,
            -357,
            -2,
            5,
            372,
            -187,
            201,
            -58,
            185,
            152,
            -82,
            -12,
            244,
            119,
            105,
            88,
            -32,
            -161,
            267,
            73,
            -126,
            -181,
            -9,
            -146,
            -8,
            127,
            75,
            42,
            -25,
            104,
            -145,
            -229,
            -178,
            342,
            18,
            -193,
            -85,
            -133,
            175,
            -219,
            115,
            67,
            313,
            -305,
            -85,
            108,
            189,
            82,
            -51,
            -204,
            -187,
            -42,
            66,
            8,
            -60,
            -37,
            61,
            -274,
            21,
            35,
            239,
            4,
            -126,
            14,
            -181,
            157,
            -237,
            72,
            59,
            199,
            44,
            -87,
            473,
            106,
            -94,
            -22,
            -226,
            132,
            89,
            -172,
            121,
            191,
            218,
            223,
            -184,
            282,
            251,
            -258,
            -350,
            151,
            45,
            -344,
            75,
            52,
            99,
            98,
            -162,
            23,
            -341,
            -352,
            -13,
            174,
            -25,
            -248,
            66,
            -209,
            270,
            335,
            -179,
            -35,
            147,
            -178,
            -20,
            508,
            45,
            -91,
            405,
            58,
            200,
            39,
            -94,
            -182,
            190,
            -127,
            56,
            -142,
            -28,
            27,
            51,
            -388,
            73,
            74,
            -3,
            -96,
            -167,
            -273,
            -103,
            190,
            -76,
            67,
            260,
            -19,
            212,
            -2,
            71,
            -130,
            -232,
            -9,
            -60,
            -41,
            -334,
            -222,
            67,
            55,
            -245,
            34,
            239,
            -14,
            86,
            -200,
            245,
            109,
            -11,
            -232,
            -176,
            218,
            108,
            158,
            -97,
            91,
            77,
            -21,
            120,
            44,
            37,
            -210,
            64,
            -116,
            -109,
            -325,
            39,
            244,
            53,
            111,
            155,
            212,
            188,
            -93,
            -235,
            229,
            -267,
            -121,
            187,
            -22,
            -112,
            52,
            -186,
            44,
            187,
            5,
            -241,
            231,
            80,
            -76,
            113,
            -433,
            -84,
            268,
            -78,
            -241,
            186,
            -17,
            -182,
            35,
            -15,
            103,
            -139,
            32,
            -151,
            -48,
            -284,
            105,
            119,
            -114,
            10,
            -175,
            -178,
            218,
            -77,
            -61,
            207,
            118,
            172,
            -89,
            -82,
            66,
            180,
            25,
            -38,
            372,
            -22,
            -77,
            67,
            -79,
            190,
            242,
            -49,
            27,
            211,
            279,
            -24,
            25,
            237,
            -203,
            148,
            133,
            -31,
            -260,
            -98,
            294,
            1,
            -564,
            -498,
            -7,
            -68,
            -47,
            117,
            -102,
            45,
            -102,
            222,
            -27,
            94,
            -273,
            -219,
            -263,
            -175,
            23,
            62,
            -45,
            -105,
            -81,
            219,
            295,
            -135,
            -156,
            -171,
            -188,
            76,
            74,
            58,
            -51,
            153,
            213,
            -74,
            -46,
            -122,
            13,
            -177,
            106,
            -62,
            169,
            -70,
            71,
            -235,
            -117,
            -105,
            134,
            214,
            8,
            -78,
            39,
            -65,
            239,
            -83,
            140,
            225,
            25,
            -57,
            61,
            94,
            -49,
            15,
            -19,
            78,
            384,
            161,
            286,
            187,
            -156,
            7,
            -248,
            229,
            -46,
            20,
            -195,
            275,
            255,
            223,
            -23,
            70,
            130,
            -16,
            -85,
            -21,
            179,
            -24,
            -268,
            -115,
            -65,
            -60,
            -2,
            -48,
            38,
            198,
            209,
            4,
            174,
            146,
            232,
            -38,
            81,
            5,
            -8,
            222,
            8,
            15,
            269,
            165,
            71,
            -32,
            347,
            -80,
            158,
            277,
            209,
            -46,
            -121,
            391,
            122,
            -81,
            -117,
            39,
            -119,
            65,
            281,
            41,
            -99,
            -5,
            -365,
            -8,
            74,
            -177,
            -53,
            48,
            -120,
            98,
            -173,
            -76,
            -254,
            235,
            98,
            -139,
            -130,
            -181,
            -496,
            181,
            108,
            30,
            78,
            207,
            -21,
            -49,
            260,
            -394,
            206,
            18,
            -229,
            -262,
            -171,
            -245,
            153,
            284,
            20,
            125,
            -110,
            -27,
            189,
            102,
            8,
            -18,
            168,
            -59,
            -218,
            -28,
            -6,
            -13,
            -260,
            20,
            -206,
            176,
            -10,
            -314,
            -16,
            -154,
            66,
            143,
            -68,
            -3,
            -79,
            -132,
            99,
            168,
            -35,
            129,
            48,
            -261,
            -179,
            79,
            -96,
            109,
            -201,
            124,
            -180,
            -67,
            211,
            -134,
            -296,
            -184,
            -211,
            -67,
            -19,
            147,
            120,
            -2,
            8,
            -344,
            -201,
            -95,
            17,
            -157,
            120,
            7,
            -131,
            193,
            -39,
            -117,
            -253,
            103,
            -48,
            52,
            -166,
            -63,
            -245,
            8,
            68,
            149,
            112,
            207,
            -21,
            -55,
            -229,
            -215,
            -315,
            67,
            57,
            -54,
            302,
            24,
            231,
            -233,
            -127,
            -53,
            63,
            154,
            -132,
            124,
            76,
            -87,
            254,
            134,
            -37,
            79,
            176,
            31,
            -68,
            90,
            -25,
            117,
            -29,
            -153,
            157,
            287,
            261,
            -39,
            -50,
            -68,
            386,
            174,
            48,
            66,
            -102,
            -243,
            92,
            142,
            -14,
            65,
            -123,
            -63,
            20,
            -22,
            162,
            259,
            -328,
            132,
            103,
            -202,
            15,
            -73,
            -39,
            -60,
            54,
            -7,
            -87,
            62,
            25,
            415,
            271,
            209,
            34,
            123,
            15,
            -165,
            -30,
            -156,
            98,
            -194,
            -49,
            -152,
            -82,
            -157,
            -38,
            175,
            -50,
            -20,
            15,
            92,
            -109,
            236,
            -255,
            91,
            5,
            -7,
            77,
            84,
            -36,
            8,
            -201,
            20,
            -46,
            -6,
            47,
            4,
            -364,
            79,
            -61,
            103,
            -133,
            -30,
            133,
            300,
            10,
            -190,
            100,
            -148,
            15,
            29,
            -289,
            -183,
            2,
            -124,
            -1,
            312,
            59,
            230,
            290,
            -113,
            36,
            -75,
            73,
            -242,
            -43,
            17,
            264,
            92,
            48,
            -36,
            -273,
            -325,
            199,
            56,
            -85,
            -141,
            16,
            -214,
            64,
            120,
            141,
            -92,
            -146,
            -113,
            360,
            -117,
            67,
            130,
            -318,
            -285,
            -113,
            -163,
            -11,
            -4,
            -93,
            177,
            1,
            187,
            -137,
            -224,
            -158,
            27,
            14,
            59,
            -256,
            -24,
            -50,
            -111,
            -150,
            -238,
            22,
            -151,
            388,
            30,
            234,
            100,
            83,
            63,
            -513,
            -47,
            -39,
            -120,
            351,
            -36,
            53,
            173,
            149,
            39,
            114,
            91,
            -24,
            -54,
            379,
            -101,
            -266,
            144,
            21,
            209,
            252,
            -111,
            -383,
            24,
            -192,
            -231,
            -81,
            242,
            -190,
            -78,
            -165,
            168,
            -98,
            88,
            -110,
            -248,
            310,
            18,
            152,
            37,
            15,
            33,
            443,
            -140,
            -39,
            -88,
            95,
            -79,
            110,
            -95,
            -105,
            -80,
            156,
            252,
            35,
            204,
            23,
            189,
            -364,
            77,
            110,
            -61,
            237,
            -7,
            -217,
            69,
            166,
            -76,
            166,
            252,
            348,
            80,
            135,
            89,
            110,
            -20,
            47,
            -98,
            161,
            -190,
            -135,
            -78,
            82,
            611,
            14,
            190,
            141,
            67,
            -35,
            -114,
            207,
            -447,
            -6
        ];
        mockIsShortDataSets2 = [
            int16(59),
            83,
            -139,
            -184,
            144,
            81,
            131,
            -254,
            95,
            269,
            70,
            53,
            150,
            -181,
            335,
            -55,
            126,
            -181,
            -73,
            64,
            125,
            53,
            -70,
            -341,
            -274,
            -100,
            -74,
            -37,
            -29,
            37,
            81,
            -151,
            -250,
            -170,
            41,
            12,
            -320,
            -23,
            -34,
            -196,
            314,
            -94,
            3,
            -135,
            -53,
            -205,
            47,
            -374,
            -159,
            -143,
            -218,
            73,
            102,
            148,
            -30,
            241,
            35,
            46,
            -203,
            224,
            257,
            231,
            -71,
            352,
            -135,
            -67,
            43,
            -94,
            -178,
            -302,
            155,
            -177,
            126,
            129,
            31,
            23,
            247,
            -10,
            -220,
            -418,
            3,
            142,
            379,
            -68,
            234,
            51,
            311,
            95,
            88,
            202,
            33,
            93,
            -62,
            -193,
            -109,
            -93,
            -279,
            -150,
            294,
            -87,
            -93,
            67,
            -20,
            73,
            208,
            -61,
            -49,
            255,
            -175,
            -61,
            -154,
            -4,
            164,
            139,
            -80,
            -39,
            90,
            58,
            123,
            45,
            -35,
            -196,
            148,
            -111,
            32,
            64,
            152,
            177,
            -142,
            57,
            -254,
            52,
            233,
            39,
            370,
            203,
            -43,
            -137,
            204,
            220,
            -432,
            214,
            -158,
            116,
            280,
            -77,
            -89,
            110,
            141,
            -21,
            267,
            151,
            47,
            13,
            -14,
            -86,
            -103,
            103,
            -62,
            123,
            146,
            135,
            -23,
            202,
            147,
            295,
            -14,
            -159,
            -35,
            -110,
            67,
            159,
            68,
            58,
            224,
            25,
            -352,
            -103,
            -128,
            -108,
            138,
            -148,
            -133,
            -63,
            -4,
            -51,
            101,
            74,
            -105,
            278,
            72,
            140,
            224,
            -21,
            139,
            51,
            -328,
            -303,
            -14,
            -8,
            235,
            296,
            -358,
            -70,
            343,
            77,
            13,
            -184,
            2,
            25,
            -43,
            -13,
            -94,
            67,
            -186,
            431,
            359,
            -303,
            -110,
            243,
            215,
            -32,
            -31,
            -55,
            152,
            -201,
            -160,
            -39,
            -390,
            -63,
            42,
            121,
            105,
            -159,
            -214,
            119,
            117,
            175,
            291,
            -220,
            235,
            -231,
            287,
            24,
            183,
            7,
            -215,
            32,
            143,
            332,
            -287,
            -212,
            114,
            -58,
            237,
            138,
            -175,
            -275,
            365,
            206,
            478,
            -5,
            -71,
            274,
            84,
            257,
            -135,
            150,
            -53,
            10,
            -66,
            -56,
            331,
            -162,
            -30,
            -58,
            -122,
            58,
            -82,
            -257,
            -119,
            81,
            8,
            -91,
            -137,
            -204,
            -173,
            36,
            -268,
            -20,
            -78,
            346,
            179,
            -218,
            -14,
            49,
            174,
            -512,
            58,
            -360,
            -228,
            12,
            60,
            -159,
            -193,
            134,
            -12,
            40,
            257,
            -236,
            87,
            61,
            -273,
            -132,
            17,
            -130,
            12,
            106,
            196,
            -22,
            -166,
            30,
            -80,
            -68,
            -111,
            165,
            15,
            167,
            111,
            17,
            6,
            -54,
            33,
            -234,
            269,
            -161,
            219,
            -103,
            194,
            56,
            163,
            29,
            -311,
            269,
            -15,
            206,
            -21,
            467,
            -65,
            246,
            -30,
            19,
            64,
            -313,
            -61,
            19,
            50,
            56,
            81,
            103,
            103,
            169,
            -205,
            -212,
            223,
            128,
            -23,
            309,
            -172,
            30,
            139,
            55,
            -236,
            235,
            -105,
            -267,
            -5,
            224,
            -5,
            219,
            -128,
            6,
            16,
            269,
            -101,
            5,
            28,
            -13,
            -86,
            -136,
            122,
            40,
            121,
            121,
            451,
            255,
            -186,
            -106,
            -95,
            190,
            115,
            275,
            105,
            19,
            62,
            52,
            68,
            284,
            -124,
            -29,
            104,
            33,
            -11,
            58,
            187,
            -164,
            -40,
            -250,
            -92,
            78,
            -145,
            357,
            -13,
            -141,
            100,
            -122,
            -234,
            306,
            -79,
            -306,
            -239,
            166,
            -89,
            -310,
            -177,
            -21,
            241,
            -67,
            -288,
            47,
            378,
            -347,
            161,
            -268,
            -34,
            -127,
            78,
            58,
            202,
            -38,
            -101,
            -10,
            -346,
            -147,
            -70,
            87,
            -354,
            102,
            10,
            -113,
            115,
            376,
            24,
            154,
            173,
            -76,
            -216,
            265,
            295,
            79,
            -150,
            152,
            143,
            133,
            175,
            -73,
            -84,
            160,
            -157,
            -176,
            -61,
            102,
            -303,
            -147,
            138,
            98,
            82,
            24,
            -300,
            -236,
            -31,
            105,
            28,
            84,
            -108,
            -200,
            -263,
            -57,
            225,
            -56,
            -196,
            110,
            -88,
            164,
            -124,
            -30,
            293,
            9,
            -181,
            88,
            -71,
            -54,
            -522,
            55,
            283,
            -52,
            -116,
            83,
            -60,
            -286,
            -125,
            -162,
            29,
            -38,
            131,
            -142,
            -249,
            -276,
            -21,
            -481,
            -22,
            -123,
            126,
            80,
            -260,
            -173,
            -229,
            -42,
            311,
            58,
            -49,
            -62,
            36,
            -60,
            87,
            -367,
            -163,
            -328,
            -105,
            232,
            275,
            203,
            -65,
            -238,
            -374,
            -302,
            -17,
            6,
            -9,
            190,
            86,
            175,
            43,
            -78,
            3,
            -17,
            0,
            143,
            -63,
            -16,
            -184,
            -229,
            -112,
            -162,
            68,
            -59,
            -80,
            -23,
            92,
            152,
            -178,
            109,
            -160,
            -187,
            -254,
            -132,
            180,
            -489,
            -153,
            145,
            -118,
            28,
            -154,
            -105,
            331,
            -228,
            317,
            -83,
            -107,
            14,
            -36,
            113,
            -257,
            176,
            -16,
            -36,
            -77,
            -108,
            -37,
            -235,
            -46,
            119,
            213,
            -63,
            63,
            215,
            299,
            -262,
            -181,
            -40,
            -192,
            92,
            -79,
            -59,
            -341,
            -68,
            -321,
            -21,
            135,
            -97,
            -117,
            137,
            -106,
            -123,
            54,
            -327,
            132,
            -99,
            48,
            -120,
            238,
            4,
            -120,
            -256,
            -15,
            -77,
            301,
            46,
            88,
            -80,
            136,
            -63,
            96,
            214,
            188,
            14,
            44,
            12,
            -68,
            137,
            -110,
            171,
            36,
            76,
            -141,
            -172,
            -134,
            -108,
            -44,
            138,
            84,
            -18,
            104,
            -227,
            122,
            157,
            -149,
            333,
            148,
            -90,
            28,
            218,
            -112,
            4,
            -109,
            132,
            -241,
            -62,
            -57,
            62,
            288,
            17,
            39,
            14,
            11,
            -121,
            -26,
            -287,
            191,
            -106,
            123,
            98,
            -312,
            93,
            242,
            55,
            252,
            186,
            -242,
            -32,
            -376,
            101,
            -176,
            -7,
            -5,
            120,
            -193,
            -219,
            35,
            100,
            234,
            173,
            36,
            37,
            50,
            168,
            -36,
            30,
            131,
            -48,
            303,
            129,
            -23,
            -110,
            74,
            -159,
            27,
            -61,
            -11,
            40,
            421,
            66,
            -128,
            -29,
            38,
            127,
            -87,
            -113,
            -27,
            16,
            -22,
            -214,
            108,
            -193,
            -78,
            -22,
            161,
            -247,
            -563,
            -4,
            -11,
            -145,
            -24,
            1,
            234,
            34,
            252,
            -103,
            -56,
            -196,
            278,
            -30,
            34,
            308,
            -76,
            36,
            61,
            254,
            -277,
            -213,
            -23,
            59,
            -41,
            5,
            -165,
            -75,
            265,
            128,
            349,
            332,
            -305,
            360,
            117,
            -227,
            -86,
            50,
            -55,
            -76,
            169,
            -105,
            43,
            348,
            -125,
            -205,
            132,
            -77,
            244,
            260,
            -202,
            231,
            -207,
            57,
            -11,
            -328,
            -82,
            194,
            161,
            -22,
            200,
            94,
            89,
            296,
            22,
            1,
            -24,
            -83,
            295,
            23,
            -105,
            408,
            -276,
            -239,
            -342,
            144,
            217,
            -29,
            -85,
            7,
            -156,
            65,
            -68,
            -262,
            -35,
            -128,
            -192,
            138,
            158,
            230,
            145,
            -76,
            34,
            -8,
            114,
            15,
            -19,
            45,
            269,
            248,
            -352,
            102,
            35,
            -39,
            -129,
            -139,
            -176,
            177,
            116,
            -105,
            263,
            -33,
            85,
            88,
            -136,
            -19,
            148,
            10,
            -64,
            55,
            -221,
            171,
            242,
            64,
            102,
            -177,
            146,
            -157,
            351,
            -38,
            -73,
            16,
            245,
            -38,
            19,
            108,
            247,
            -273,
            10,
            -118,
            132,
            259,
            -95,
            -310,
            128,
            246,
            257,
            -187,
            -192,
            -100,
            376,
            81,
            -261,
            -212,
            -213,
            21,
            -54,
            -131,
            -79,
            235,
            198,
            377,
            300,
            -111,
            -584,
            237,
            -152,
            -209,
            -51,
            124,
            163,
            -234,
            -290,
            -95,
            -52,
            144,
            75,
            -181,
            170,
            -103,
            150,
            -132,
            47,
            -319,
            118,
            -142,
            -123,
            -34,
            -280,
            375,
            181,
            41,
            135,
            -70,
            -145,
            -62,
            71,
            -9,
            -66,
            -29,
            -176,
            -129,
            -104,
            7,
            44,
            40,
            -90,
            -335,
            182,
            -40,
            211,
            -135,
            39,
            215,
            -41,
            108,
            48,
            -208,
            418,
            208,
            -133,
            118,
            110,
            107,
            -17,
            28,
            -215,
            110,
            -138,
            -161,
            113,
            -92,
            123,
            -383,
            -137,
            -207,
            122,
            -2,
            -39,
            214,
            -141,
            -244,
            -288,
            -48,
            31,
            4,
            22,
            -102,
            501,
            159,
            -2,
            -78,
            283,
            109,
            -26,
            -143,
            212,
            189,
            152,
            -87,
            113,
            -131,
            280,
            -240,
            -132,
            -154
        ];
    }

    // test decoding of packed public key
    function test_pk_decode() public view {
        uint256 numberOfDataSets = mockData.mockDataSetsLength();
        for (uint256 i = 0; i < numberOfDataSets; i++) {
            (bytes memory _publicKey, uint16[1024] memory publicKey) = mockData.getKeyData(i);
            //act
            (uint16[1024] memory decodedPk) = falconPkPackedUtils.decodePkPacked(_publicKey);
            //assert
            bool isEqual = true;
            for (uint256 j = 0; j < n; j++) {
                if (publicKey[j] != decodedPk[j]) {
                    console.log("mismatch at index: %s", j);
                    console.log("original: %s", publicKey[j]);
                    console.log("decoded: %s", decodedPk[j]);
                    isEqual = false;
                    break;
                }
            }
            assertTrue(isEqual, "Decoded public key should match original");
        }
    }

    //test decoding of compressed signature
    function test_sig_decode_signature() public view {
        uint256 numberOfDataSets = mockData.mockDataSetsLength();
        for (uint256 i = 0; i < numberOfDataSets; i++) {
            (bytes memory _signature, int16[1024] memory signature) = mockData.getSignatureData(i);
            //act
            (, int16[1024] memory decodedSig) = falconSigCompressedUtils.decode(_signature);
            //assert
            bool isEqual = true;
            for (uint256 j = 0; j < n; j++) {
                if (signature[j] != decodedSig[j]) {
                    console.log("mismatch at index: %s", j);
                    console.log("original: %s", signature[j]);
                    console.log("decoded: %s", decodedSig[j]);
                    isEqual = false;
                    break;
                }
            }
            assertTrue(isEqual, "Decoded signature should match original");
        }
    }

    //test decoding of nonce
    function test_sig_decode_nonce() public view {
        uint256 numberOfDataSets = mockData.mockDataSetsLength();
        for (uint256 i = 0; i < numberOfDataSets; i++) {
            (bytes memory _signature, bytes memory nonce,) = mockData.getNonceData(i);
            //act
            (bytes memory _nonce,) = falconSigCompressedUtils.decode(_signature);
            //assert
            assertEq(_nonce, nonce, "Decoded nonce should match original");
        }
    }
    /*
    //test decoding of signature with too many bytes
     function test_sign_decode_tooManyBytes() public view {
        uint256 numberOfDataSets = mockData.mockDataSetsLength();
        for (uint i=0; i < numberOfDataSets; i++){
            (bytes memory _signature,) = mockData.getSignatureData(i);
            
            bytes memory signature = abi.encodePacked(_signature, uint8(0xFF), uint8(0xFF), uint8(0xFF), uint8(0xFF)); // same as abi.encodePacked here
            vm.expectRevert("sig len");
            falconSigCompressedUtils.decode(signature);
        }
    }
    /*
    //test decoding of signature with too manyfew bytes
    function test_sign_decode_tooFewBytes() public {
            bytes memory signature = abi.encodePacked(uint8(0x30));
            vm.expectRevert(bytes("sig len"));
            falconSigCompressedUtils.decode(signature);
    }

    //test decoding of signature with wrong header byte
    function test_sign_decode_wrongHeader() public {
        uint256 numberOfDataSets = mockData.mockDataSetsLength();
        for (uint i=0; i < numberOfDataSets; i++){
            (, ,,, bytes memory _signature,,) = mockData.getMockDataSet(i);
            _signature[0] = 0x31; // change header byte to something invalid
            vm.expectRevert("header");
            falconSigCompressedUtils.decode(_signature);
        }
    } */

    // order is hashedMessage, signature, publicKey, recovered_s0, bytes_signature, bytes_publicKey
    function test_s1_extract() public view {
        uint256 numberOfDataSets = mockData.mockDataSetsLength();
        for (uint256 i = 0; i < numberOfDataSets; i++) {
            (
                uint16[1024] memory hashedMessage,
                int16[1024] memory signature,
                uint16[1024] memory publicKey,
                int16[1024] memory check_sig
            ) = mockData.getAllArrays(i);
            require(check_sig.length == 1024, "check_sig length should be 1024");
            require(signature.length == 1024, "signature length should be 1024");
            require(publicKey.length == 1024, "publicKey length should be 1024");
            require(hashedMessage.length == 1024, "hashedMessage length should be 1024");
            //act
            uint16[1024] memory moNTTyPublicKey = falconVerify.toMoNTTy(publicKey);
            (int16[1024] memory extractedS1) = falconVerify.fetch_signature(hashedMessage, signature, moNTTyPublicKey);
            //assert
            bool isEqual = true;
            for (uint256 j = 0; j < 1024; j++) {
                if (check_sig[j] != extractedS1[j]) {
                    console.log("mismatch at index: %s", j);
                    console.log("check_sig: %s", check_sig[j]);
                    console.log("extractedS1: %s", extractedS1[j]);
                    isEqual = false;
                    break;
                }
            }
            assertTrue(isEqual, "Extracted s1 should match check_sig");
        }
    }

    function test_is_short() public view {
        uint256 numberOfDataSets = mockData.mockDataSetsLength();
        for (uint256 i = 0; i < numberOfDataSets; i++) {
            (uint16[1024] memory hashedMessage, int16[1024] memory signature, uint16[1024] memory publicKey,) =
                mockData.getAllArrays(i);
            require(signature.length == 1024, "signature length should be 1024");
            require(publicKey.length == 1024, "publicKey length should be 1024");
            require(hashedMessage.length == 1024, "hashedMessage length should be 1024");
            //act
            uint16[1024] memory moNTTyPublicKey = falconVerify.toMoNTTy(publicKey);
            (int16[1024] memory extractedS1) = falconVerify.fetch_signature(hashedMessage, signature, moNTTyPublicKey);
            //assert
            bool isShort = falconVerify._is_short(signature, extractedS1);
            assertTrue(isShort, "Extracted s1 should be short");
        }
    }

    function testFalconVerify() public view {
        //signed messages and public keys will be from the same MockFalconData object
        //arrange
        uint256 numberOfDataSets = mockData.mockDataSetsLength();
        for (uint256 i = 0; i < numberOfDataSets; i++) {
            (uint16[1024] memory hashedMessage, int16[1024] memory signature, uint16[1024] memory publicKey,) =
                mockData.getAllArrays(i);
            //act
            uint16[1024] memory moNTTyPublicKey = falconVerify.toMoNTTy(publicKey);
            bool isValid = falconVerify._is_short(
                signature, falconVerify.fetch_signature(hashedMessage, signature, moNTTyPublicKey)
            );
            //assert
            assertTrue(isValid, "Signature should be valid");
        }
    }

    function testFalconVerifyFail() public view {
        //signed messages and public keys will be from different MockFalconData objects
        //arrange
        uint256 numberOfDataSets = mockData.mockDataSetsLength();
        for (uint256 i = 0; i < numberOfDataSets; i++) {
            (uint16[1024] memory hashedMessage, int16[1024] memory signature, uint16[1024] memory publicKey,) =
                mockData.getAllArrays(i);
            //act
            uint16[1024] memory moNTTyPublicKey = falconVerify.toMoNTTy(publicKey);
            bool isValid = falconVerify._is_short(
                signature, falconVerify.fetch_signature(moNTTyPublicKey, signature, hashedMessage)
            );
            //assert
            assertTrue(!isValid, "Signature should not be valid");
        }
    }
}
